<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰«é›·æ¸¸æˆ</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 50%, #ffd3b6 100%);
            box-sizing: border-box;
            overflow: auto;  /* å…è®¸æ»šåŠ¨ä»¥ç¡®ä¿å†…å®¹å®Œæ•´æ˜¾ç¤º */
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 100%;
            min-height: 100vh;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        .board {
            display: inline-block;
            background: #bdbdbd;
            padding: 5px;
            border: 3px solid #7b7b7b;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            margin: 0 auto;  /* æ°´å¹³å±…ä¸­ */
        }

        .row {
            display: flex;
            line-height: 0;
        }

        .cell {
            margin: 0;
            padding: 0;
            border: 0;
            background: #c6c6c6;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-family: Arial, sans-serif;
            user-select: none;
            position: relative;
            box-sizing: border-box;
        }
        
        .cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #7b7b7b;
            border-bottom: 2px solid #7b7b7b;
            box-sizing: border-box;
        }
        
        .cell:active:not(.revealed):not(.flagged)::before {
            border: 1px solid #7b7b7b;
        }
        
        .revealed {
            background: #e6e6e6;
        }
        
        /* ä¿®æ”¹å·²æ˜¾ç¤ºæ ¼å­çš„è¾¹æ¡†æ ·å¼ */
        .revealed::before {
            display: block;  /* æ˜¾ç¤ºè¾¹æ¡† */
            border: 1px solid #bdbdbd;  /* ä½¿ç”¨æŸ”å’Œçš„è¾¹æ¡†é¢œè‰² */
        }
        
        .mine {
            background: #ff4444;
        }
        
        .mine::before {
            border-color: #ff0000;  /* åœ°é›·æ ¼å­ä½¿ç”¨çº¢è‰²è¾¹æ¡† */
        }
        
        .flagged::before {
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #7b7b7b;
            border-bottom: 2px solid #7b7b7b;
        }
        /* æ·»åŠ æ•°å­—é¢œè‰² */
        .revealed[data-number="1"] { color: #0000ff; }
        .revealed[data-number="2"] { color: #007b00; }
        .revealed[data-number="3"] { color: #ff0000; }
        .revealed[data-number="4"] { color: #00007b; }
        .revealed[data-number="5"] { color: #7b0000; }
        .revealed[data-number="6"] { color: #007b7b; }
        .revealed[data-number="7"] { color: #000000; }
        .revealed[data-number="8"] { color: #7b7b7b; }
        
        /* æ·»åŠ æ§åˆ¶é¢æ¿æ ·å¼ */
        .controls {
            width: 100%;
            max-width: 600px;
            margin-bottom: 10px;  /* å‡å°è¾¹è· */
            padding: 5px 10px;    /* å‡å°å†…è¾¹è· */
        }
        .mine-counter {
            background: #000;
            color: #ff0000;
            padding: 5px 15px;
            font-family: 'Digital', monospace;
            font-size: 20px;      /* å›ºå®šå¤§å° */
            border: 2px solid #7b7b7b;
        }
        .reset-button {
            padding: 8px 24px;
            font-size: 16px;      /* å›ºå®šå¤§å° */
            background: #e0e0e0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #7b7b7b;
            border-bottom: 2px solid #7b7b7b;
        }
        .reset-button:active {
            background: #c0c0c0;
            border: 2px solid #7b7b7b;
        }
        
        /* æ·»åŠ éš¾åº¦é€‰æ‹©å™¨æ ·å¼ */
        .difficulty-selector {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .difficulty-btn {
            padding: 5px 15px;
            font-size: 14px;
            background: #e0e0e0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #7b7b7b;
            border-bottom: 2px solid #7b7b7b;
        }
        
        .difficulty-btn.active {
            background: #b0b0b0;
            border: 2px solid #7b7b7b;
        }
        
        .custom-mines {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .custom-mines input {
            width: 60px;
            padding: 4px;
            border: 2px solid #7b7b7b;
            border-radius: 4px;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .peek-button {
            padding: 8px 24px;
            font-size: 16px;
            background: #e0e0e0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #7b7b7b;
            border-bottom: 2px solid #7b7b7b;
        }
        
        .peek-button.active {
            background: #b0b0b0;
            border: 2px solid #7b7b7b;
        }
        
        /* æ·»åŠ é¢„è§ˆçŠ¶æ€çš„æ ¼å­æ ·å¼ */
        .cell.peeking {
            opacity: 0.7;
        }
        
        /* æ·»åŠ æŒ‰ä¸‹çŠ¶æ€çš„æ ·å¼ */
        .cell.pressing::before {
            border: 2px solid #7b7b7b !important;
            background: #a0a0a0;
        }
        
        .cell.pressing-neighbor::before {
            border: 2px solid #7b7b7b !important;
            background: #a0a0a0;
        }

        /* ä¿®æ”¹ç§»åŠ¨ç«¯æ ·å¼ */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .game-container {
                min-height: auto;
                padding: 10px;
                width: 100%;
                box-sizing: border-box;
            }
            
            .board {
                margin: 10px auto;
                padding: 2px;
                border: 2px solid #7b7b7b;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }
            
            .difficulty-selector {
                flex-direction: column;
                align-items: stretch;
                margin-bottom: 8px;
                gap: 5px;
            }
            
            .difficulty-btn {
                padding: 8px;
                font-size: 13px;
                height: 35px;
            }
            
            .custom-mines {
                display: flex;
                gap: 5px;
                justify-content: center;
                height: 35px;
            }
            
            .custom-mines input {
                width: 60px;
                padding: 4px;
                font-size: 13px;
            }
            
            .controls {
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
                margin: 5px 0;
                height: 40px;
            }
            
            .mine-counter {
                padding: 4px 10px;
                font-size: 15px;
                height: 30px;
                display: flex;
                align-items: center;
            }
            
            .reset-button, .peek-button {
                padding: 6px 12px;
                font-size: 13px;
                height: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="difficulty-selector">
            <button class="difficulty-btn active" data-difficulty="easy">ç®€å• (12Ã—12, 20é›·)</button>
            <button class="difficulty-btn" data-difficulty="medium">ä¸­ç­‰ (16Ã—16, 40é›·)</button>
            <button class="difficulty-btn" data-difficulty="hard">å›°éš¾ (22Ã—22, 99é›·)</button>
            <div class="custom-mines">
                <input type="number" id="customMines" min="10" max="80" value="40">
                <button class="difficulty-btn" data-difficulty="custom">è‡ªå®šä¹‰</button>
            </div>
        </div>
        <div class="controls">
            <div class="mine-counter">ğŸ’£ <span id="mineCount">20</span></div>
            <button class="reset-button" onclick="resetGame()">é‡æ–°å¼€å§‹</button>
            <button class="peek-button" onclick="togglePeek()">æŸ¥çœ‹åœ°é›·</button>
        </div>
        <div id="board" class="board"></div>
    </div>

    <script>
        // è¿™é‡Œç²˜è´´æ‚¨ä¹‹å‰çš„ MineSweeper å¯¹è±¡ä»£ç 
        const MineSweeper = {
            config: {
                rows: 16,
                cols: 16,
                mines: 40,
                cellSize: 0,
                // ä¿®æ”¹éš¾åº¦é…ç½®ï¼Œæ·»åŠ æ£‹ç›˜å¤§å°
                difficulties: {
                    easy: { mines: 20, name: 'ç®€å•', size: 12 },     // 12x12 çš„æ£‹ç›˜
                    medium: { mines: 40, name: 'ä¸­ç­‰', size: 16 },   // 16x16 çš„æ£‹ç›˜
                    hard: { mines: 99, name: 'å›°éš¾', size: 22 },     // 22x22 çš„æ£‹ç›˜
                    custom: { mines: 40, name: 'è‡ªå®šä¹‰', size: 16 }  // é»˜è®¤16x16
                }
            },
            
            data: {
                board: [],
                revealed: [],
                flagged: [],
                mineCount: 0,
                gameOver: false,
                isFirstClick: true,
                isPeeking: false,
                savedState: null,
                // æ·»åŠ è§¦é›·å‰çŠ¶æ€ä¿å­˜
                lastState: null
            },
            
            calculateCellSize() {
                // è·å–è§†å£å°ºå¯¸
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                // ç§»åŠ¨ç«¯ç‰¹åˆ«å¤„ç†
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // è®¡ç®—å¯ç”¨ç©ºé—´
                    const usableWidth = viewportWidth - 20;    // é¢„ç•™å·¦å³è¾¹è·
                    const usableHeight = viewportHeight - 200;  // é¢„ç•™é¡¶éƒ¨å’Œåº•éƒ¨UIçš„ç©ºé—´
                    
                    // å…ˆè®¡ç®—æ¯ä¸ªæ ¼å­çš„ç†æƒ³å¤§å°
                    let cellSize;
                    if (this.config.rows <= 12) { // ç®€å•æ¨¡å¼
                        cellSize = 30;
                    } else if (this.config.rows <= 16) { // ä¸­ç­‰æ¨¡å¼
                        cellSize = 26;
                    } else { // å›°éš¾æ¨¡å¼
                        cellSize = 22;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦ä¼šè¶…å‡ºå±å¹•å®½åº¦
                    const totalWidth = this.config.cols * cellSize;
                    if (totalWidth > usableWidth) {
                        // å¦‚æœä¼šè¶…å‡ºï¼Œé‡æ–°è®¡ç®—æ ¼å­å¤§å°å’Œåˆ—æ•°
                        const maxCols = Math.floor(usableWidth / cellSize);
                        if (maxCols < this.config.cols) {
                            // è°ƒæ•´åˆ—æ•°å’Œè¡Œæ•°ï¼Œä¿æŒå¤§è‡´ç›¸åŒçš„éš¾åº¦
                            const reduction = this.config.cols - maxCols;
                            this.config.cols = maxCols;
                            this.config.rows = Math.max(this.config.rows - reduction, 8); // ç¡®ä¿æœ€å°8x8
                            
                            // æŒ‰æ¯”ä¾‹è°ƒæ•´åœ°é›·æ•°
                            const ratio = (maxCols * this.config.rows) / (this.config.cols * (this.config.rows + reduction));
                            this.config.mines = Math.max(Math.floor(this.config.mines * ratio), 10); // ç¡®ä¿æœ€å°‘10ä¸ªåœ°é›·
                            
                            // éœ€è¦é‡æ–°åˆå§‹åŒ–æ¸¸æˆæ•°æ®
                            this.data.board = Array(this.config.rows).fill().map(() => Array(this.config.cols).fill(0));
                            this.data.revealed = Array(this.config.rows).fill().map(() => Array(this.config.cols).fill(false));
                            this.data.flagged = Array(this.config.rows).fill().map(() => Array(this.config.cols).fill(false));
                            this.data.mineCount = this.config.mines;
                            this.data.isFirstClick = true;
                        }
                    }
                    
                    // è®¾ç½®æœ€ç»ˆçš„æ ¼å­å¤§å°
                    this.config.cellSize = cellSize;
                    
                    // æ›´æ–°å®¹å™¨æ ·å¼ä»¥é€‚åº”æ–°çš„æ£‹ç›˜å¤§å°
                    const container = document.querySelector('.game-container');
                    if (container) {
                        const boardWidth = this.config.cols * cellSize;
                        const horizontalPadding = Math.max((viewportWidth - boardWidth - 20) / 2, 10);
                        container.style.padding = `10px ${horizontalPadding}px`;
                    }
                    
                    // æ‰“å°è°ƒè¯•ä¿¡æ¯
                    console.log('Mobile layout:');
                    console.log('Viewport:', viewportWidth, 'x', viewportHeight);
                    console.log('Board size:', this.config.rows, 'x', this.config.cols);
                    console.log('Cell size:', cellSize);
                    console.log('Mines:', this.config.mines);
                    
                    // æ›´æ–°éš¾åº¦æŒ‰é’®æ–‡æœ¬
                    const activeBtn = document.querySelector('.difficulty-btn.active');
                    if (activeBtn) {
                        const difficulty = activeBtn.dataset.difficulty;
                        if (difficulty !== 'custom') {
                            activeBtn.textContent = `${this.config.difficulties[difficulty].name} (${this.config.rows}Ã—${this.config.cols}, ${this.config.mines}é›·)`;
                        }
                    }
                } else {
                    // PCç«¯ä¿æŒåŸæœ‰é€»è¾‘
                    const containerPadding = 40;
                    const controlsHeight = 120;
                    const difficultyHeight = 60;
                    
                    const availableWidth = viewportWidth - (containerPadding * 2);
                    const availableHeight = viewportHeight - (containerPadding * 2) - controlsHeight - difficultyHeight;
                    
                    const maxCellSizeByWidth = Math.floor(availableWidth / this.config.cols);
                    const maxCellSizeByHeight = Math.floor(availableHeight / this.config.rows);
                    
                    this.config.cellSize = Math.min(Math.max(
                        Math.min(maxCellSizeByWidth, maxCellSizeByHeight),
                        25
                    ), 40);
                }
            },
            
            init() {
                this.calculateCellSize();  // åˆå§‹åŒ–æ—¶è®¡ç®—æ ¼å­å¤§å°
                // åˆå§‹åŒ–æ•°æ®
                this.data.board = Array(this.config.rows).fill().map(() => Array(this.config.cols).fill(0));
                this.data.revealed = Array(this.config.rows).fill().map(() => Array(this.config.cols).fill(false));
                this.data.flagged = Array(this.config.rows).fill().map(() => Array(this.config.cols).fill(false));
                this.data.mineCount = this.config.mines;  // ç¡®ä¿ä½¿ç”¨å½“å‰é…ç½®çš„åœ°é›·æ•°
                this.data.gameOver = false;
                this.data.isFirstClick = true;
            },
            
            // æ·»åŠ æ–°æ–¹æ³•ï¼šæ”¾ç½®åœ°é›·
            placeMines(firstRow, firstCol) {
                let minesPlaced = 0;
                const totalMines = this.config.mines;  // ä½¿ç”¨å½“å‰é…ç½®çš„åœ°é›·æ•°
                
                while (minesPlaced < totalMines) {  // ä½¿ç”¨å±€éƒ¨å˜é‡ç¡®ä¿æ”¾ç½®æ­£ç¡®æ•°é‡çš„åœ°é›·
                    const row = Math.floor(Math.random() * this.config.rows);
                    const col = Math.floor(Math.random() * this.config.cols);
                    
                    if (this.data.board[row][col] !== -1 && 
                        (Math.abs(row - firstRow) > 1 || Math.abs(col - firstCol) > 1)) {
                        this.data.board[row][col] = -1;
                        minesPlaced++;
                        
                        // æ›´æ–°å‘¨å›´æ ¼å­çš„æ•°å­—
                        for(let i = -1; i <= 1; i++) {
                            for(let j = -1; j <= 1; j++) {
                                if (i === 0 && j === 0) continue;
                                
                                const newRow = row + i;
                                const newCol = col + j;
                                
                                if (newRow >= 0 && newRow < this.config.rows &&
                                    newCol >= 0 && newCol < this.config.cols &&
                                    this.data.board[newRow][newCol] !== -1) {
                                    this.data.board[newRow][newCol]++;
                                }
                            }
                        }
                    }
                }
            },
            
            reveal(row, col) {
                if (this.data.gameOver) {
                    return;
                }

                // å¦‚æœç‚¹å‡»çš„æ˜¯å·²ç»æ˜¾ç¤ºçš„æ ¼å­
                if (this.data.revealed[row][col]) {
                    const number = this.data.board[row][col];
                    if (number > 0) {  // åªå¤„ç†æ˜¾ç¤ºæ•°å­—çš„æ ¼å­
                        // è®¡ç®—å‘¨å›´æœªå¼€æ ¼å­å’Œå·²æ ‡è®°åœ°é›·æ•°
                        let unrevealedCount = 0;
                        let flagCount = 0;
                        let unrevealedCells = [];
                        
                        for (let i = -1; i <= 1; i++) {
                            for (let j = -1; j <= 1; j++) {
                                const newRow = row + i;
                                const newCol = col + j;
                                if (newRow >= 0 && newRow < this.config.rows &&
                                    newCol >= 0 && newCol < this.config.cols) {
                                    if (this.data.flagged[newRow][newCol]) {
                                        flagCount++;
                                    }
                                    if (!this.data.revealed[newRow][newCol] && !this.data.flagged[newRow][newCol]) {
                                        unrevealedCount++;
                                        unrevealedCells.push([newRow, newCol]);
                                    }
                                }
                            }
                        }
                        
                        // å¦‚æœæœªå¼€æ ¼å­æ•°é‡ + å·²æ ‡è®°æ•°é‡ = æ•°å­—ï¼Œåˆ™æ ‡è®°æ‰€æœ‰æœªå¼€æ ¼å­
                        if (unrevealedCount + flagCount === number) {
                            unrevealedCells.forEach(([r, c]) => {
                                this.flag(r, c);
                            });
                            return;
                        }
                        
                        // å¦‚æœæ ‡è®°æ•°ç­‰äºæ ¼å­æ˜¾ç¤ºçš„æ•°å­—ï¼Œæ‰“å¼€å‘¨å›´æœªæ ‡è®°çš„æ ¼å­
                        if (flagCount === number) {
                            for (let i = -1; i <= 1; i++) {
                                for (let j = -1; j <= 1; j++) {
                                    const newRow = row + i;
                                    const newCol = col + j;
                                    if (newRow >= 0 && newRow < this.config.rows &&
                                        newCol >= 0 && newCol < this.config.cols &&
                                        !this.data.revealed[newRow][newCol] &&
                                        !this.data.flagged[newRow][newCol]) {
                                        this.reveal(newRow, newCol);
                                    }
                                }
                            }
                        }
                    }
                    return;
                }
                
                if (this.data.flagged[row][col]) {
                    return;
                }
                
                // å¤„ç†ç¬¬ä¸€æ¬¡ç‚¹å‡»
                if (this.data.isFirstClick) {
                    this.data.isFirstClick = false;
                    this.placeMines(row, col);  // åœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»åæ‰æ”¾ç½®åœ°é›·
                }
                
                this.data.revealed[row][col] = true;
                
                if (this.data.board[row][col] === -1) {
                    // è§¦é›·å‰ä¿å­˜å½“å‰çŠ¶æ€å’Œè§¦é›·ä½ç½®
                    this.data.lastState = {
                        revealed: JSON.parse(JSON.stringify(this.data.revealed)),
                        flagged: JSON.parse(JSON.stringify(this.data.flagged)),
                        mineCount: this.data.mineCount,
                        lastMineRow: row,    // ä¿å­˜è§¦é›·çš„è¡Œ
                        lastMineCol: col     // ä¿å­˜è§¦é›·çš„åˆ—
                    };
                    // å…ˆæ˜¾ç¤ºè¿™ä¸ªåœ°é›·
                    renderBoard();
                    
                    // è¯¢é—®æ˜¯å¦é‡è¯•
                    setTimeout(() => {
                        if (confirm('è¸©åˆ°åœ°é›·äº†ï¼æ˜¯å¦é‡è¯•ï¼Ÿ')) {
                            this.retry();
                        } else {
                            this.gameOver(false);
                        }
                    }, 100);
                    return;
                }
                
                if (this.data.board[row][col] === 0) {
                    this.revealArea(row, col);
                }
                
                this.checkWin();
            },
            
            ensureSafeArea(row, col) {
                const safeArea = [];
                for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                        const newRow = row + i;
                        const newCol = col + j;
                        if (newRow >= 0 && newRow < this.config.rows &&
                            newCol >= 0 && newCol < this.config.cols) {
                            safeArea.push([newRow, newCol]);
                        }
                    }
                }
                
                safeArea.forEach(([r, c]) => {
                    if (this.data.board[r][c] === -1) {
                        this.data.board[r][c] = 0;
                        for (let i = -1; i <= 1; i++) {
                            for (let j = -1; j <= 1; j++) {
                                const nr = r + i;
                                const nc = c + j;
                                if (nr >= 0 && nr < this.config.rows &&
                                    nc >= 0 && nc < this.config.cols &&
                                    this.data.board[nr][nc] !== -1) {
                                    this.data.board[nr][nc]--;
                                }
                            }
                        }
                    }
                });
                
                for (let i = 0; i < this.config.rows; i++) {
                    for (let j = 0; j < this.config.cols; j++) {
                        if (!safeArea.some(([r, c]) => r === i && c === j) && 
                            this.data.board[i][j] !== -1 &&
                            Math.random() < 0.2) {
                            this.data.board[i][j] = -1;
                            for (let di = -1; di <= 1; di++) {
                                for (let dj = -1; dj <= 1; dj++) {
                                    if (di === 0 && dj === 0) continue;
                                    const nr = i + di;
                                    const nc = j + dj;
                                    if (nr >= 0 && nr < this.config.rows &&
                                        nc >= 0 && nc < this.config.cols &&
                                        this.data.board[nr][nc] !== -1) {
                                        this.data.board[nr][nc]++;
                                    }
                                }
                            }
                        }
                    }
                }
            },
            
            revealArea(row, col) {
                for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                        const newRow = row + i;
                        const newCol = col + j;
                        
                        if (newRow >= 0 && newRow < this.config.rows &&
                            newCol >= 0 && newCol < this.config.cols &&
                            !this.data.revealed[newRow][newCol] &&
                            !this.data.flagged[newRow][newCol]) {
                            this.data.revealed[newRow][newCol] = true;
                            if (this.data.board[newRow][newCol] === 0) {
                                this.revealArea(newRow, newCol);
                            }
                        }
                    }
                }
            },
            
            flag(row, col) {
                if (this.data.gameOver || this.data.revealed[row][col]) {
                    return;
                }
                
                if (!this.data.flagged[row][col] && this.data.mineCount > 0) {
                    this.data.flagged[row][col] = true;
                    this.data.mineCount--;
                } else if (this.data.flagged[row][col]) {
                    this.data.flagged[row][col] = false;
                    this.data.mineCount++;
                }
            },
            
            checkWin() {
                for(let i = 0; i < this.config.rows; i++) {
                    for(let j = 0; j < this.config.cols; j++) {
                        if (this.data.board[i][j] !== -1 && !this.data.revealed[i][j]) {
                            return false;
                        }
                    }
                }
                this.gameOver(true);
                return true;
            },
            
            gameOver(isWin) {
                this.data.gameOver = true;
                if (!isWin) {
                    // æ˜¾ç¤ºæ‰€æœ‰åœ°é›·
                    for(let i = 0; i < this.config.rows; i++) {
                        for(let j = 0; j < this.config.cols; j++) {
                            if (this.data.board[i][j] === -1) {
                                this.data.revealed[i][j] = true;
                            }
                        }
                    }
                    renderBoard();
                    setTimeout(() => {
                        alert('æ¸¸æˆç»“æŸï¼');
                    }, 100);
                } else {
                    setTimeout(() => {
                        alert('æ­å–œä½ èµ¢äº†ï¼');
                    }, 100);
                }
            },
            
            // æ·»åŠ è®¾ç½®æ£‹ç›˜å¤§å°çš„æ–¹æ³•
            setBoardSize(mines) {
                // æ ¹æ®åœ°é›·æ•°é‡åŠ¨æ€è®¡ç®—åˆé€‚çš„æ£‹ç›˜å¤§å°
                let size;
                if (mines <= 20) {
                    size = 12;  // å°æ£‹ç›˜
                } else if (mines <= 40) {
                    size = 16;  // ä¸­ç­‰æ£‹ç›˜
                } else if (mines <= 60) {
                    size = 19;  // è¾ƒå¤§æ£‹ç›˜
                } else {
                    size = 22;  // æœ€å¤§æ£‹ç›˜
                }
                
                this.config.rows = size;
                this.config.cols = size;
            },
            
            // æ·»åŠ é‡è¯•æ–¹æ³•
            retry() {
                if (this.data.lastState) {
                    this.data.revealed = JSON.parse(JSON.stringify(this.data.lastState.revealed));
                    this.data.flagged = JSON.parse(JSON.stringify(this.data.lastState.flagged));
                    this.data.mineCount = this.data.lastState.mineCount;
                    this.data.gameOver = false;
                    // ç§»é™¤æœ€åä¸€æ­¥æ˜¾ç¤ºçš„åœ°é›·
                    this.data.revealed[this.data.lastState.lastMineRow][this.data.lastState.lastMineCol] = false;
                    renderBoard();
                }
            }
        };
        
        // æ·»åŠ æ¸²æŸ“å’Œäº‹ä»¶å¤„ç†ä»£ç 
        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            for(let i = 0; i < MineSweeper.config.rows; i++) {
                const row = document.createElement('div');
                row.className = 'row';
                
                for(let j = 0; j < MineSweeper.config.cols; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    // æ·»åŠ æ•°æ®å±æ€§å­˜å‚¨åæ ‡
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    
                    if(MineSweeper.data.revealed[i][j]) {
                        cell.classList.add('revealed');
                        if(MineSweeper.data.board[i][j] === -1) {
                            cell.classList.add('mine');
                            cell.textContent = 'ğŸ’£';
                        } else if(MineSweeper.data.board[i][j] > 0) {
                            cell.textContent = MineSweeper.data.board[i][j];
                            cell.setAttribute('data-number', MineSweeper.data.board[i][j]);
                        }
                        
                        if(MineSweeper.data.isPeeking && !MineSweeper.data.savedState.revealed[i][j]) {
                            cell.classList.add('peeking');
                        }
                    } else if(MineSweeper.data.flagged[i][j]) {
                        cell.classList.add('flagged');
                        cell.textContent = 'ğŸš©';
                    }
                    
                    row.appendChild(cell);
                }
                board.appendChild(row);
            }

            // å¦‚æœè¿˜æ²¡æœ‰æ·»åŠ è¿‡äº‹ä»¶ç›‘å¬ï¼Œåˆ™æ·»åŠ 
            if (!board.hasAttribute('data-events-attached')) {
                // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
                board.addEventListener('mousedown', handleMouseDown);
                // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
                board.addEventListener('mouseover', handleMouseOver);
                // é¼ æ ‡ç¦»å¼€äº‹ä»¶
                board.addEventListener('mouseout', handleMouseOut);
                // é¼ æ ‡å³é”®äº‹ä»¶
                board.addEventListener('contextmenu', handleContextMenu);
                // ç‚¹å‡»äº‹ä»¶
                board.addEventListener('click', handleClick);
                
                // æ ‡è®°å·²æ·»åŠ äº‹ä»¶ç›‘å¬
                board.setAttribute('data-events-attached', 'true');
            }
        }

        // äº‹ä»¶å¤„ç†å‡½æ•°
        function handleMouseDown(e) {
            if (MineSweeper.data.isPeeking || e.button !== 0) return;
            
            const cell = e.target.closest('.cell');
            if (!cell) return;

            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            if (!MineSweeper.data.revealed[row][col]) {
                cell.classList.add('pressing');
            } else if (MineSweeper.data.board[row][col] > 0) {
                pressNeighbors(row, col);
            }
        }

        function handleMouseOver(e) {
            if (MineSweeper.data.isPeeking || !e.buttons) return;
            
            const cell = e.target.closest('.cell');
            if (!cell) return;

            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            if (!MineSweeper.data.revealed[row][col]) {
                cell.classList.add('pressing');
            } else if (MineSweeper.data.board[row][col] > 0) {
                pressNeighbors(row, col);
            }
        }

        function handleMouseOut(e) {
            const cell = e.target.closest('.cell');
            if (!cell) return;
            
            cell.classList.remove('pressing');
            clearAllPressing();
        }

        function handleContextMenu(e) {
            e.preventDefault();
            if (MineSweeper.data.isPeeking) return;
            
            const cell = e.target.closest('.cell');
            if (!cell) return;

            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            
            MineSweeper.flag(row, col);
            renderBoard();
            document.getElementById('mineCount').textContent = MineSweeper.data.mineCount;
        }

        function handleClick(e) {
            if (MineSweeper.data.isPeeking) return;
            
            const cell = e.target.closest('.cell');
            if (!cell) return;

            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            
            MineSweeper.reveal(row, col);
        }

        // æ·»åŠ å…¨å±€é¼ æ ‡æŠ¬èµ·äº‹ä»¶
        document.addEventListener('mouseup', () => {
            clearAllPressing();
        });

        // æ·»åŠ æŒ‰ä¸‹å‘¨å›´æ ¼å­çš„å‡½æ•°
        function pressNeighbors(row, col) {
            for(let i = -1; i <= 1; i++) {
                for(let j = -1; j <= 1; j++) {
                    const newRow = row + i;
                    const newCol = col + j;
                    
                    if (newRow >= 0 && newRow < MineSweeper.config.rows &&
                        newCol >= 0 && newCol < MineSweeper.config.cols) {
                        const cells = document.querySelectorAll('.cell');
                        const index = newRow * MineSweeper.config.cols + newCol;
                        const neighborCell = cells[index];
                        
                        if (!MineSweeper.data.revealed[newRow][newCol] && 
                            !MineSweeper.data.flagged[newRow][newCol]) {
                            neighborCell.classList.add('pressing-neighbor');
                        }
                    }
                }
            }
        }

        // ä¿®æ”¹æ ·å¼ç›¸å…³çš„ä»£ç 
        function updateStyles() {
            const oldStyle = document.getElementById('dynamic-cell-styles');
            if (oldStyle) {
                oldStyle.remove();
            }

            const styleSheet = document.createElement('style');
            styleSheet.id = 'dynamic-cell-styles';
            
            // æ·»åŠ å“åº”å¼æ ·å¼
            styleSheet.textContent = `
                .cell {
                    width: ${MineSweeper.config.cellSize}px;
                    height: ${MineSweeper.config.cellSize}px;
                    font-size: ${Math.max(MineSweeper.config.cellSize * 0.5, 12)}px;
                }
                
                @media (max-width: 768px) {
                    .game-container {
                        padding: 10px;
                    }
                    
                    .difficulty-selector {
                        flex-wrap: wrap;
                        gap: 5px;
                    }
                    
                    .difficulty-btn {
                        padding: 4px 8px;
                        font-size: 12px;
                    }
                    
                    .controls {
                        padding: 5px;
                    }
                    
                    .mine-counter {
                        padding: 3px 8px;
                        font-size: 16px;
                    }
                    
                    .reset-button, .peek-button {
                        padding: 5px 12px;
                        font-size: 14px;
                    }
                }
            `;
            document.head.appendChild(styleSheet);
        }

        function resetGame() {
            MineSweeper.data.isPeeking = false;
            MineSweeper.data.savedState = null;
            document.querySelector('.peek-button').classList.remove('active');
            document.querySelector('.peek-button').textContent = 'æŸ¥çœ‹åœ°é›·';
            MineSweeper.init();
            updateStyles();
            renderBoard();
            document.getElementById('mineCount').textContent = MineSweeper.data.mineCount;
        }

        // ä¿®æ”¹ gameOver æ–¹æ³•æ¥æ›´æ–°ç•Œé¢
        const originalGameOver = MineSweeper.gameOver;
        MineSweeper.gameOver = function(isWin) {
            originalGameOver.call(this, isWin);
            renderBoard();
        }

        // ä¿®æ”¹ reveal æ–¹æ³•æ¥æ›´æ–°ç•Œé¢
        const originalReveal = MineSweeper.reveal;
        MineSweeper.reveal = function(row, col) {
            originalReveal.call(this, row, col);
            renderBoard();
        }

        // æ·»åŠ çª—å£å¤§å°æ”¹å˜äº‹ä»¶ç›‘å¬
        window.addEventListener('resize', () => {
            resetGame();
        });

        // æ·»åŠ éš¾åº¦é€‰æ‹©çš„äº‹ä»¶å¤„ç†
        function initDifficultySelector() {
            const buttons = document.querySelectorAll('.difficulty-btn');
            const customInput = document.getElementById('customMines');
            
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // ç§»é™¤å…¶ä»–æŒ‰é’®çš„activeç±»
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const difficulty = btn.dataset.difficulty;
                    if (difficulty === 'custom') {
                        const mines = parseInt(customInput.value);
                        if (mines >= 10 && mines <= 80) {
                            MineSweeper.config.mines = mines;
                            MineSweeper.setBoardSize(mines);  // è®¾ç½®æ£‹ç›˜å¤§å°
                        } else {
                            alert('è¯·è¾“å…¥10-80ä¹‹é—´çš„æ•°å­—');
                            return;
                        }
                    } else {
                        const config = MineSweeper.config.difficulties[difficulty];
                        MineSweeper.config.mines = config.mines;
                        MineSweeper.config.rows = config.size;
                        MineSweeper.config.cols = config.size;
                    }
                    
                    resetGame();
                });
            });
            
            // è‡ªå®šä¹‰è¾“å…¥æ¡†çš„å¤„ç†
            customInput.addEventListener('change', () => {
                const mines = parseInt(customInput.value);
                if (mines < 10) customInput.value = 10;
                if (mines > 80) customInput.value = 80;
            });
        }

        // åœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨
        initDifficultySelector();

        // åˆå§‹åŒ–æ¸¸æˆ
        resetGame();

        // æ·»åŠ é¢„è§ˆåˆ‡æ¢å‡½æ•°
        function togglePeek() {
            const peekButton = document.querySelector('.peek-button');
            
            if (!MineSweeper.data.isPeeking) {
                // ä¿å­˜å½“å‰çŠ¶æ€
                MineSweeper.data.savedState = {
                    revealed: JSON.parse(JSON.stringify(MineSweeper.data.revealed)),
                    flagged: JSON.parse(JSON.stringify(MineSweeper.data.flagged))
                };
                
                // æ˜¾ç¤ºæ‰€æœ‰æ ¼å­
                for(let i = 0; i < MineSweeper.config.rows; i++) {
                    for(let j = 0; j < MineSweeper.config.cols; j++) {
                        MineSweeper.data.revealed[i][j] = true;
                    }
                }
                
                MineSweeper.data.isPeeking = true;
                peekButton.classList.add('active');
                peekButton.textContent = 'æ¢å¤æ¸¸æˆ';
            } else {
                // æ¢å¤ä¿å­˜çš„çŠ¶æ€
                MineSweeper.data.revealed = JSON.parse(JSON.stringify(MineSweeper.data.savedState.revealed));
                MineSweeper.data.flagged = JSON.parse(JSON.stringify(MineSweeper.data.savedState.flagged));
                
                MineSweeper.data.isPeeking = false;
                peekButton.classList.remove('active');
                peekButton.textContent = 'æŸ¥çœ‹åœ°é›·';
            }
            
            renderBoard();
        }

        // æ·»åŠ æ¸…é™¤æ‰€æœ‰æŒ‰å‹æ•ˆæœçš„è¾…åŠ©å‡½æ•°
        function clearAllPressing() {
            document.querySelectorAll('.pressing, .pressing-neighbor')
                .forEach(cell => {
                    cell.classList.remove('pressing');
                    cell.classList.remove('pressing-neighbor');
                });
        }
    </script>
</body>
</html>