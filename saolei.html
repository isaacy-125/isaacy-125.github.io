<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>æ‰«é›·æ¸¸æˆ</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            min-height: 100%;
            width: 100%;
            background: linear-gradient(135deg,
                    #a8e6cf 0%,
                    #dcedc1 50%,
                    #ffd3b6 100%);
        }

        body {
            padding: 10px;
            box-sizing: border-box;
            overflow-y: scroll;
            /* å§‹ç»ˆæ˜¾ç¤ºæ»šåŠ¨æ¡ï¼Œé˜²æ­¢æŠ–åŠ¨ */
            -webkit-overflow-scrolling: touch;
            /* iOS æ»šåŠ¨ä¼˜åŒ– */
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 100%;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        .board {
            display: inline-block;
            background: #bdbdbd;
            padding: 5px;
            border: 3px solid #7b7b7b;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            margin: 10px auto;
            max-width: 100%;
            box-sizing: border-box;
        }

        .row {
            display: flex;
            line-height: 0;
        }

        .cell {
            margin: 0;
            padding: 0;
            border: 0;
            background: #c6c6c6;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-family: Arial, sans-serif;
            user-select: none;
            position: relative;
            box-sizing: border-box;
        }

        .cell::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #7b7b7b;
            border-bottom: 2px solid #7b7b7b;
            box-sizing: border-box;
        }

        .cell:active:not(.revealed):not(.flagged)::before {
            border: 1px solid #7b7b7b;
        }

        .revealed {
            background: #e6e6e6;
        }

        /* ä¿®æ”¹å·²æ˜¾ç¤ºæ ¼å­çš„è¾¹æ¡†æ ·å¼ */
        .revealed::before {
            display: block;
            /* æ˜¾ç¤ºè¾¹æ¡† */
            border: 1px solid #bdbdbd;
            /* ä½¿ç”¨æŸ”å’Œçš„è¾¹æ¡†é¢œè‰² */
        }

        .mine {
            background: #ff4444;
        }

        .mine::before {
            border-color: #ff0000;
            /* åœ°é›·æ ¼å­ä½¿ç”¨çº¢è‰²è¾¹æ¡† */
        }

        .flagged::before {
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #7b7b7b;
            border-bottom: 2px solid #7b7b7b;
        }

        /* æ·»åŠ æ•°å­—é¢œè‰² */
        .revealed[data-number="1"] {
            color: #0000ff;
        }

        .revealed[data-number="2"] {
            color: #007b00;
        }

        .revealed[data-number="3"] {
            color: #ff0000;
        }

        .revealed[data-number="4"] {
            color: #00007b;
        }

        .revealed[data-number="5"] {
            color: #7b0000;
        }

        .revealed[data-number="6"] {
            color: #007b7b;
        }

        .revealed[data-number="7"] {
            color: #000000;
        }

        .revealed[data-number="8"] {
            color: #7b7b7b;
        }

        /* æ·»åŠ æ§åˆ¶é¢æ¿æ ·å¼ */
        .controls {
            position: relative;
            display: flex;
            justify-content: center;  /* æ”¹å›å±…ä¸­ */
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px 120px;  /* ä¿æŒå·¦å³ç©ºé—´ */
            box-sizing: border-box;
        }

        .mine-counter {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #000;
            color: #ff0000;
            padding: 5px 15px;
            font-family: "Digital", monospace;
            font-size: 20px;
            border: 2px solid #7b7b7b;
            z-index: 1;
        }

        .reset-button {
            padding: 8px 24px;
            font-size: 16px;
            /* å›ºå®šå¤§å° */
            background: #e0e0e0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #7b7b7b;
            border-bottom: 2px solid #7b7b7b;
        }

        .reset-button:active {
            background: #c0c0c0;
            border: 2px solid #7b7b7b;
        }

        /* æ·»åŠ éš¾åº¦é€‰æ‹©å™¨æ ·å¼ */
        .difficulty-selector {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .difficulty-btn {
            padding: 5px 15px;
            font-size: 14px;
            background: #e0e0e0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #7b7b7b;
            border-bottom: 2px solid #7b7b7b;
        }

        .difficulty-btn.active {
            background: #b0b0b0;
            border: 2px solid #7b7b7b;
        }

        .custom-mines {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .custom-mines input {
            width: 60px;
            padding: 4px;
            border: 2px solid #7b7b7b;
            border-radius: 4px;
        }

        .peek-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 8px 24px;
            font-size: 16px;
            background: #e0e0e0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #7b7b7b;
            border-bottom: 2px solid #7b7b7b;
        }

        .peek-button.active {
            background: #b0b0b0;
            border: 2px solid #7b7b7b;
        }

        /* æ·»åŠ é¢„è§ˆçŠ¶æ€çš„æ ¼å­æ ·å¼ */
        .cell.peeking {
            opacity: 0.7;
        }

        /* æ·»åŠ æŒ‰ä¸‹çŠ¶æ€çš„æ ·å¼ */
        .cell.pressing::before {
            border: 2px solid #7b7b7b !important;
            background: #a0a0a0;
        }

        .cell.pressing-neighbor::before {
            border: 2px solid #7b7b7b !important;
            background: #a0a0a0;
        }

        /* æ·»åŠ ä¾§è¾¹æŒ‰é’®å’Œå¼¹å‡ºæ¡†æ ·å¼ */
        .mobile-settings-btn {
            display: none;
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 100;
            cursor: move;
            touch-action: none;
            transition: all 0.3s ease;
            user-select: none;
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .settings-content {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 80%;
            max-width: 300px;
            background: white;
            padding: 20px;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
        }

        .close-settings {
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
        }

        /* ä¿®æ”¹ç§»åŠ¨ç«¯æ ·å¼ */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .game-container {
                padding: 10px 5px;
                margin-bottom: 10px;
            }

            .controls {
                padding: 10px 90px;  /* ç§»åŠ¨ç«¯å‡å°‘padding */
            }

            .board {
                margin: 5px auto;
                padding: 3px;
                border-width: 2px;
            }

            .mobile-settings-btn {
                position: fixed;
                z-index: 1000;
            }

            /* è®¾ç½®æ¨¡æ€æ¡†æ ·å¼ */
            .settings-modal {
                position: fixed;
                z-index: 2000;
            }

            .settings-content {
                position: fixed;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .mine-counter {
                font-size: 16px;
                padding: 3px 10px;
            }

            .reset-button, .peek-button {
                padding: 5px 12px;
                font-size: 14px;
            }
        }

        /* ä¿®æ”¹æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body>
    <div class="game-container">
        <button class="mobile-settings-btn">âš™ï¸</button>
        <div class="difficulty-selector">
            <button class="difficulty-btn active" data-difficulty="easy">
                ç®€å• (12Ã—12, 20é›·)
            </button>
            <button class="difficulty-btn" data-difficulty="medium">
                ä¸­ç­‰ (16Ã—16, 40é›·)
            </button>
            <button class="difficulty-btn" data-difficulty="hard">
                å›°éš¾ (22Ã—22, 99é›·)
            </button>
            <div class="custom-mines">
                <input type="number" id="customMines" min="10" max="80" value="40" />
                <button class="difficulty-btn" data-difficulty="custom">
                    è‡ªå®šä¹‰
                </button>
            </div>
        </div>
        <div class="controls">
            <div class="mine-counter">ğŸ’£ <span id="remaining-mines">0</span></div>
            <button class="reset-button" onclick="resetGame()">é‡æ–°å¼€å§‹</button>
            <button class="peek-button" onclick="togglePeek()">æŸ¥çœ‹åœ°é›·</button>
        </div>
        <div id="board" class="board"></div>
    </div>

    <div class="settings-modal">
        <div class="settings-content">
            <span class="close-settings">&times;</span>
            <h3>æ¸¸æˆè®¾ç½®</h3>
            <div class="difficulty-selector">
                <!-- å°†åŸæœ‰çš„éš¾åº¦é€‰æ‹©å™¨å†…å®¹ç§»åŠ¨åˆ°è¿™é‡Œ -->
            </div>
        </div>
    </div>

    <script>
        // è¿™é‡Œç²˜è´´æ‚¨ä¹‹å‰çš„ MineSweeper å¯¹è±¡ä»£ç 
        const MineSweeper = {
            config: {
                rows: 16,
                cols: 16,
                mines: 40,
                cellSize: 0,
                difficulties: {
                    easy: { mines: 20, name: "ç®€å•", size: 12 },
                    medium: { mines: 40, name: "ä¸­ç­‰", size: 16 },
                    hard: { mines: 99, name: "å›°éš¾", size: 22 },
                    custom: { mines: 40, name: "è‡ªå®šä¹‰", size: 16 },
                },
                mobileConfig: null,
                sounds: {
                    reveal: null,
                    flag: null,
                    mine: null,
                    win: null
                },
                soundUrls: {
                    reveal: "./saolei_resource/reveal.mp3",
                    flag: "./saolei_resource/flag.mp3",
                    mine: "./saolei_resource/mine.mp3",
                    win: "./saolei_resource/win.mp3"
                }
            },

            data: {
                board: [],
                revealed: [],
                flagged: [],
                mineCount: 0,
                gameOver: false,
                isFirstClick: true,
                isPeeking: false,
                savedState: null,
                lastState: null,
            },

            calculateCellSize() {
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const isMobile = window.innerWidth <= 768;

                if (isMobile) {
                    if (!this.config.mobileConfig) {
                        this.config.mobileConfig = {
                            easy: { ...this.config.difficulties.easy },
                            medium: { ...this.config.difficulties.medium },
                            hard: { ...this.config.difficulties.hard },
                        };

                        // è®¡ç®—åˆé€‚çš„æ ¼å­å¤§å°
                        const usableWidth = viewportWidth - 20; // é¢„ç•™å·¦å³è¾¹è·
                        let cellSize = 30; // é»˜è®¤æ ¼å­å¤§å°

                        // æ ¹æ®å±å¹•å®½åº¦è®¡ç®—æ¯è¡Œå¯ä»¥æ”¾ç½®çš„æ ¼å­æ•°
                        const cols = Math.floor(usableWidth / cellSize);

                        // ä¸ºæ¯ä¸ªéš¾åº¦çº§åˆ«è®¡ç®—æ–°çš„é…ç½®
                        ["easy", "medium", "hard"].forEach((difficulty) => {
                            const originalConfig = this.config.mobileConfig[difficulty];
                            const originalArea = originalConfig.size * originalConfig.size;
                            const originalDensity = originalConfig.mines / originalArea;

                            // è®¡ç®—æ–°çš„è¡Œæ•°ï¼Œä¿æŒåœ°é›·å¯†åº¦
                            const rows = Math.ceil(
                                (originalArea * cellSize * cellSize) /
                                (usableWidth * cellSize)
                            );

                            // è®¡ç®—æ–°çš„åœ°é›·æ•°ï¼Œä¿æŒå¯†åº¦
                            const newArea = cols * rows;
                            const newMines = Math.round(newArea * originalDensity);

                            // æ›´æ–°é…ç½®
                            this.config.difficulties[difficulty] = {
                                ...originalConfig,
                                size: cols, // åˆ—æ•°ç­‰äºæœ€å¤§å¯æ”¾ç½®æ•°
                                rows: rows, // å•ç‹¬å­˜å‚¨è¡Œæ•°
                                cols: cols, // å•ç‹¬å­˜å‚¨åˆ—æ•°
                                mines: newMines,
                            };
                        });

                        // æ›´æ–°å½“å‰é…ç½®
                        const currentDifficulty = document.querySelector(
                            ".difficulty-btn.active"
                        ).dataset.difficulty;
                        if (currentDifficulty !== "custom") {
                            const config = this.config.difficulties[currentDifficulty];
                            this.config.rows = config.rows;
                            this.config.cols = config.cols;
                            this.config.mines = config.mines;
                        }

                        // æ›´æ–°éš¾åº¦æŒ‰é’®æ–‡æœ¬
                        document.querySelectorAll(".difficulty-btn").forEach((btn) => {
                            const diff = btn.dataset.difficulty;
                            if (diff !== "custom") {
                                const config = this.config.difficulties[diff];
                                btn.textContent = `${config.name} (${config.cols}Ã—${config.rows}, ${config.mines}é›·)`;
                            }
                        });

                        this.config.cellSize = cellSize;
                    }
                } else {
                    // PCç«¯æ¢å¤åŸå§‹é…ç½®
                    if (this.config.mobileConfig) {
                        Object.assign(this.config.difficulties, this.config.mobileConfig);
                        this.config.mobileConfig = null;

                        const currentDifficulty = document.querySelector(
                            ".difficulty-btn.active"
                        ).dataset.difficulty;
                        if (currentDifficulty !== "custom") {
                            const config = this.config.difficulties[currentDifficulty];
                            this.config.rows = config.size;
                            this.config.cols = config.size;
                            this.config.mines = config.mines;
                        }

                        document.querySelectorAll(".difficulty-btn").forEach((btn) => {
                            const diff = btn.dataset.difficulty;
                            if (diff !== "custom") {
                                const config = this.config.difficulties[diff];
                                btn.textContent = `${config.name} (${config.size}Ã—${config.size}, ${config.mines}é›·)`;
                            }
                        });
                    }

                    // PCç«¯çš„æ ¼å­å¤§å°è®¡ç®—
                    const containerPadding = 40;
                    const controlsHeight = 120;
                    const difficultyHeight = 60;

                    const availableWidth = viewportWidth - containerPadding * 2;
                    const availableHeight =
                        viewportHeight -
                        containerPadding * 2 -
                        controlsHeight -
                        difficultyHeight;

                    const maxCellSizeByWidth = Math.floor(
                        availableWidth / this.config.cols
                    );
                    const maxCellSizeByHeight = Math.floor(
                        availableHeight / this.config.rows
                    );

                    this.config.cellSize = Math.min(
                        Math.max(Math.min(maxCellSizeByWidth, maxCellSizeByHeight), 25),
                        40
                    );
                }
            },

            init() {
                this.calculateCellSize(); // åˆå§‹åŒ–æ—¶è®¡ç®—æ ¼å­å¤§å°
                // åˆå§‹åŒ–æ•°æ®
                this.data.board = Array(this.config.rows)
                    .fill()
                    .map(() => Array(this.config.cols).fill(0));
                this.data.revealed = Array(this.config.rows)
                    .fill()
                    .map(() => Array(this.config.cols).fill(false));
                this.data.flagged = Array(this.config.rows)
                    .fill()
                    .map(() => Array(this.config.cols).fill(false));
                this.data.mineCount = this.config.mines; // ç¡®ä¿ä½¿ç”¨å½“å‰é…ç½®çš„åœ°é›·æ•°
                this.data.gameOver = false;
                this.data.isFirstClick = true;
            },

            // æ·»åŠ æ–°æ–¹æ³•ï¼šæ”¾ç½®åœ°é›·
            placeMines(firstRow, firstCol) {
                let minesPlaced = 0;
                const totalMines = this.config.mines; // ä½¿ç”¨å½“å‰é…ç½®çš„åœ°é›·æ•°

                while (minesPlaced < totalMines) {
                    // ä½¿ç”¨å±€éƒ¨å˜é‡ç¡®ä¿æ”¾ç½®æ­£ç¡®æ•°é‡çš„åœ°é›·
                    const row = Math.floor(Math.random() * this.config.rows);
                    const col = Math.floor(Math.random() * this.config.cols);

                    if (
                        this.data.board[row][col] !== -1 &&
                        (Math.abs(row - firstRow) > 1 || Math.abs(col - firstCol) > 1)
                    ) {
                        this.data.board[row][col] = -1;
                        minesPlaced++;

                        // æ›´æ–°å‘¨å›´æ ¼å­çš„æ•°å­—
                        for (let i = -1; i <= 1; i++) {
                            for (let j = -1; j <= 1; j++) {
                                if (i === 0 && j === 0) continue;

                                const newRow = row + i;
                                const newCol = col + j;

                                if (
                                    newRow >= 0 &&
                                    newRow < this.config.rows &&
                                    newCol >= 0 &&
                                    newCol < this.config.cols &&
                                    this.data.board[newRow][newCol] !== -1
                                ) {
                                    this.data.board[newRow][newCol]++;
                                }
                            }
                        }
                    }
                }
            },

            reveal(row, col) {
                if (this.data.gameOver) {
                    return;
                }

                // å¦‚æœç‚¹å‡»çš„æ˜¯å·²ç»æ˜¾ç¤ºçš„æ ¼å­
                if (this.data.revealed[row][col]) {
                    const number = this.data.board[row][col];
                    if (number > 0) {
                        let flagCount = 0;
                        let unrevealedCount = 0;
                        let unrevealedCells = [];
                        let hasSafeCell = false;

                        // æ£€æŸ¥å‘¨å›´çš„æ ¼å­
                        for (let i = -1; i <= 1; i++) {
                            for (let j = -1; j <= 1; j++) {
                                const newRow = row + i;
                                const newCol = col + j;
                                if (
                                    newRow >= 0 &&
                                    newRow < this.config.rows &&
                                    newCol >= 0 &&
                                    newCol < this.config.cols
                                ) {
                                    if (this.data.flagged[newRow][newCol]) {
                                        flagCount++;
                                    }
                                    if (!this.data.revealed[newRow][newCol] && !this.data.flagged[newRow][newCol]) {
                                        unrevealedCount++;
                                        unrevealedCells.push([newRow, newCol]);
                                        // æ£€æŸ¥æ˜¯å¦æœ‰æœªæ‰“å¼€ä¸”ä¸æ˜¯åœ°é›·çš„æ ¼å­
                                        if (this.data.board[newRow][newCol] !== -1) {
                                            hasSafeCell = true;
                                        }
                                    }
                                }
                            }
                        }

                        // å¦‚æœæœªå¼€æ ¼å­æ•°é‡ + å·²æ ‡è®°æ•°é‡ = æ•°å­—ï¼Œåˆ™æ ‡è®°æ‰€æœ‰æœªå¼€æ ¼å­
                        if (unrevealedCount + flagCount === number) {
                            // ä¸æ’­æ”¾éŸ³æ•ˆï¼Œåªæ ‡è®°æ ¼å­
                            unrevealedCells.forEach(([r, c]) => {
                                this.flag(r, c);
                            });
                            return;
                        }

                        // å¦‚æœæ ‡è®°æ•°ç­‰äºæ•°å­—ï¼Œæ‰“å¼€å‘¨å›´æœªæ ‡è®°çš„æ ¼å­
                        if (flagCount === number && hasSafeCell) {
                            let hasRevealedSafe = false;
                            
                            for (let i = -1; i <= 1; i++) {
                                for (let j = -1; j <= 1; j++) {
                                    const newRow = row + i;
                                    const newCol = col + j;
                                    if (
                                        newRow >= 0 &&
                                        newRow < this.config.rows &&
                                        newCol >= 0 &&
                                        newCol < this.config.cols &&
                                        !this.data.revealed[newRow][newCol] &&
                                        !this.data.flagged[newRow][newCol]
                                    ) {
                                        if (this.data.board[newRow][newCol] !== -1) {
                                            hasRevealedSafe = true;
                                        }
                                        this.data.revealed[newRow][newCol] = true;
                                        if (this.data.board[newRow][newCol] === 0) {
                                            this.revealArea(newRow, newCol);
                                        }
                                    }
                                }
                            }
                            
                            // åªæœ‰åœ¨å®é™…æ‰“å¼€äº†å®‰å…¨æ ¼å­æ—¶æ‰æ’­æ”¾éŸ³æ•ˆ
                            if (hasRevealedSafe) {
                                playSound('reveal');  // æ‰“å¼€å®‰å…¨åŒºåŸŸæ—¶æ’­æ”¾ reveal éŸ³æ•ˆ
                            }
                        }
                        return;
                    }
                    return;
                }

                if (this.data.flagged[row][col]) {
                    return;
                }

                // å¤„ç†ç¬¬ä¸€æ¬¡ç‚¹å‡»
                if (this.data.isFirstClick) {
                    this.data.isFirstClick = false;
                    this.placeMines(row, col);
                }

                this.data.revealed[row][col] = true;

                if (this.data.board[row][col] === -1) {
                    playSound('mine');  // è¸©åˆ°åœ°é›·æ—¶æ’­æ”¾ mine éŸ³æ•ˆ
                    // è§¦é›·å‰ä¿å­˜å½“å‰çŠ¶æ€å’Œè§¦é›·ä½ç½®
                    this.data.lastState = {
                        revealed: JSON.parse(JSON.stringify(this.data.revealed)),
                        flagged: JSON.parse(JSON.stringify(this.data.flagged)),
                        mineCount: this.data.mineCount,
                        lastMineRow: row, // ä¿å­˜è§¦é›·çš„è¡Œ
                        lastMineCol: col, // ä¿å­˜è§¦é›·çš„åˆ—
                    };
                    // å…ˆæ˜¾ç¤ºè¿™ä¸ªåœ°é›·
                    renderBoard();

                    // è¯¢é—®æ˜¯å¦é‡è¯•
                    setTimeout(() => {
                        if (confirm("è¸©åˆ°åœ°é›·äº†ï¼æ˜¯å¦é‡è¯•ï¼Ÿ")) {
                            this.retry();
                        } else {
                            this.gameOver(false);
                        }
                    }, 100);
                    return;
                }

                // æ ¹æ®æ‰“å¼€çš„æ ¼å­ç±»å‹æ’­æ”¾éŸ³æ•ˆ
                if (this.data.board[row][col] === 0) {
                    playSound('reveal');  // æ‰“å¼€ç©ºç™½åŒºåŸŸæ—¶æ’­æ”¾ reveal éŸ³æ•ˆ
                    this.revealArea(row, col);
                } else {
                    playSound('flag');  // æ‰“å¼€å®‰å…¨çš„æ•°å­—æ ¼å­æ—¶æ’­æ”¾ flag éŸ³æ•ˆ
                }

                renderBoard();
                this.checkWin();  // åœ¨æ¸²æŸ“åæ£€æŸ¥èƒœåˆ©
            },

            ensureSafeArea(row, col) {
                const safeArea = [];
                for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                        const newRow = row + i;
                        const newCol = col + j;
                        if (
                            newRow >= 0 &&
                            newRow < this.config.rows &&
                            newCol >= 0 &&
                            newCol < this.config.cols
                        ) {
                            safeArea.push([newRow, newCol]);
                        }
                    }
                }

                safeArea.forEach(([r, c]) => {
                    if (this.data.board[r][c] === -1) {
                        this.data.board[r][c] = 0;
                        for (let i = -1; i <= 1; i++) {
                            for (let j = -1; j <= 1; j++) {
                                const nr = r + i;
                                const nc = c + j;
                                if (
                                    nr >= 0 &&
                                    nr < this.config.rows &&
                                    nc >= 0 &&
                                    nc < this.config.cols &&
                                    this.data.board[nr][nc] !== -1
                                ) {
                                    this.data.board[nr][nc]--;
                                }
                            }
                        }
                    }
                });

                for (let i = 0; i < this.config.rows; i++) {
                    for (let j = 0; j < this.config.cols; j++) {
                        if (
                            !safeArea.some(([r, c]) => r === i && c === j) &&
                            this.data.board[i][j] !== -1 &&
                            Math.random() < 0.2
                        ) {
                            this.data.board[i][j] = -1;
                            for (let di = -1; di <= 1; di++) {
                                for (let dj = -1; dj <= 1; dj++) {
                                    if (di === 0 && dj === 0) continue;
                                    const nr = i + di;
                                    const nc = j + dj;
                                    if (
                                        nr >= 0 &&
                                        nr < this.config.rows &&
                                        nc >= 0 &&
                                        nc < this.config.cols &&
                                        this.data.board[nr][nc] !== -1
                                    ) {
                                        this.data.board[nr][nc]++;
                                    }
                                }
                            }
                        }
                    }
                }
            },

            revealArea(row, col) {
                for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                        const newRow = row + i;
                        const newCol = col + j;

                        if (
                            newRow >= 0 &&
                            newRow < this.config.rows &&
                            newCol >= 0 &&
                            newCol < this.config.cols &&
                            !this.data.revealed[newRow][newCol] &&
                            !this.data.flagged[newRow][newCol]
                        ) {
                            this.data.revealed[newRow][newCol] = true;
                            if (this.data.board[newRow][newCol] === 0) {
                                this.revealArea(newRow, newCol);
                            }
                        }
                    }
                }
                this.checkWin();  // åœ¨å±•å¼€åŒºåŸŸåä¹Ÿæ£€æŸ¥èƒœåˆ©æ¡ä»¶
            },

            flag(row, col) {
                if (this.data.gameOver || this.data.revealed[row][col]) {
                    return;
                }

                if (!this.data.flagged[row][col] && this.data.mineCount > 0) {
                    this.data.flagged[row][col] = true;
                    this.data.mineCount--;
                    playSound('reveal');
                } else if (this.data.flagged[row][col]) {
                    this.data.flagged[row][col] = false;
                    this.data.mineCount++;
                    playSound('reveal');
                }

                document.getElementById("remaining-mines").textContent = this.data.mineCount;
                renderBoard();
                this.checkWin();  // åœ¨æ¸²æŸ“åæ£€æŸ¥èƒœåˆ©
            },

            checkWin() {
                // å¦‚æœå·²ç»æ¸¸æˆç»“æŸï¼Œä¸å†æ£€æŸ¥
                if (this.data.gameOver) {
                    return false;
                }

                let allSafeCellsRevealed = true;
                let allMinesMarked = true;
                let mineCount = 0;
                let markedCount = 0;

                // éå†æ‰€æœ‰æ ¼å­
                for (let i = 0; i < this.config.rows; i++) {
                    for (let j = 0; j < this.config.cols; j++) {
                        if (this.data.board[i][j] === -1) {
                            // æ˜¯åœ°é›·
                            mineCount++;
                            if (!this.data.flagged[i][j]) {
                                allMinesMarked = false;
                            } else {
                                markedCount++;
                            }
                        } else {
                            // ä¸æ˜¯åœ°é›·
                            if (!this.data.revealed[i][j]) {
                                allSafeCellsRevealed = false;
                            }
                        }
                    }
                }

                // èƒœåˆ©æ¡ä»¶ï¼šæ‰€æœ‰å®‰å…¨æ ¼å­éƒ½è¢«æ­ç¤ºï¼Œä¸”æ‰€æœ‰åœ°é›·éƒ½è¢«æ­£ç¡®æ ‡è®°
                if (allSafeCellsRevealed && allMinesMarked && mineCount === markedCount) {
                    this.gameOver(true);
                    return true;
                }

                return false;
            },

            gameOver(isWin) {
                this.data.gameOver = true;
                if (!isWin) {
                    // åªæœ‰åœ¨è¸©åˆ°åœ°é›·æ—¶æ‰æ’­æ”¾çˆ†ç‚¸éŸ³æ•ˆï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦æ’­æ”¾
                    
                    // æ˜¾ç¤ºæ‰€æœ‰åœ°é›·
                    for (let i = 0; i < this.config.rows; i++) {
                        for (let j = 0; j < this.config.cols; j++) {
                            if (this.data.board[i][j] === -1) {
                                this.data.revealed[i][j] = true;
                            }
                        }
                    }
                    renderBoard();
                    setTimeout(() => {
                        alert("æ¸¸æˆç»“æŸï¼");
                    }, 100);
                } else {
                    playSound('win');
                    setTimeout(() => {
                        alert("æ­å–œä½ èµ¢äº†ï¼");
                    }, 100);
                }
            },

            // ä¿®æ”¹ setBoardSize æ–¹æ³•
            setBoardSize(mines) {
                // æ ¹æ®åœ°é›·æ•°é‡åŠ¨æ€è®¡ç®—åˆé€‚çš„æ£‹ç›˜å¤§å°
                let size;
                if (mines <= 20) {
                    size = 12; // å°æ£‹ç›˜
                } else if (mines <= 40) {
                    size = 16; // ä¸­ç­‰æ£‹ç›˜
                } else if (mines <= 60) {
                    size = 19; // è¾ƒå¤§æ£‹ç›˜
                } else {
                    size = 22; // æœ€å¤§æ£‹ç›˜
                }

                // ç¡®ä¿è®¾ç½®æ­£ç¡®çš„è¡Œåˆ—æ•°
                this.config.rows = size;
                this.config.cols = size;
                this.config.mines = mines;  // ç¡®ä¿è®¾ç½®æ­£ç¡®çš„åœ°é›·æ•°
            },

            // ä¿®æ”¹éš¾åº¦é€‰æ‹©çš„å¤„ç†ä»£ç 
            initDifficultySelector() {
                const buttons = document.querySelectorAll(".difficulty-btn");
                const customInput = document.getElementById("customMines");
                const self = this;  // ä¿å­˜ MineSweeper çš„å¼•ç”¨

                buttons.forEach((btn) => {
                    btn.addEventListener("click", () => {
                        buttons.forEach((b) => b.classList.remove("active"));
                        btn.classList.add("active");

                        const difficulty = btn.dataset.difficulty;
                        if (difficulty === "custom") {
                            const mines = parseInt(customInput.value);
                            if (mines >= 10 && mines <= 80) {
                                self.setBoardSize(mines);  // ä½¿ç”¨ä¿å­˜çš„å¼•ç”¨
                                self.config.mines = mines;  // ä½¿ç”¨ä¿å­˜çš„å¼•ç”¨
                            } else {
                                alert("è¯·è¾“å…¥10-80ä¹‹é—´çš„æ•°å­—");
                                return;
                            }
                        } else {
                            const config = self.config.difficulties[difficulty];
                            self.config.mines = config.mines;
                            self.config.rows = config.rows || config.size;
                            self.config.cols = config.cols || config.size;
                        }

                        resetGame();
                    });
                });

                // è‡ªå®šä¹‰è¾“å…¥æ¡†çš„å¤„ç†
                customInput.addEventListener("change", () => {
                    const mines = parseInt(customInput.value);
                    if (mines < 10) customInput.value = 10;
                    if (mines > 80) customInput.value = 80;
                });
            },

            // æ·»åŠ é‡è¯•æ–¹æ³•
            retry() {
                if (this.data.lastState) {
                    this.data.revealed = JSON.parse(
                        JSON.stringify(this.data.lastState.revealed)
                    );
                    this.data.flagged = JSON.parse(
                        JSON.stringify(this.data.lastState.flagged)
                    );
                    this.data.mineCount = this.data.lastState.mineCount;
                    this.data.gameOver = false;
                    // ç§»é™¤æœ€åä¸€æ­¥æ˜¾ç¤ºçš„åœ°é›·
                    this.data.revealed[this.data.lastState.lastMineRow][
                        this.data.lastState.lastMineCol
                    ] = false;
                    renderBoard();
                }
            },
        };

        // æ·»åŠ æ¸²æŸ“å’Œäº‹ä»¶å¤„ç†ä»£ç 
        function renderBoard() {
            const board = document.getElementById("board");
            board.innerHTML = "";

            for (let i = 0; i < MineSweeper.config.rows; i++) {
                const row = document.createElement("div");
                row.className = "row";

                for (let j = 0; j < MineSweeper.config.cols; j++) {
                    const cell = document.createElement("div");
                    cell.className = "cell";
                    // æ·»åŠ æ•°æ®å±æ€§å­˜å‚¨åæ ‡
                    cell.dataset.row = i;
                    cell.dataset.col = j;

                    if (MineSweeper.data.revealed[i][j]) {
                        cell.classList.add("revealed");
                        if (MineSweeper.data.board[i][j] === -1) {
                            cell.classList.add("mine");
                            cell.textContent = "ğŸ’£";
                        } else if (MineSweeper.data.board[i][j] > 0) {
                            cell.textContent = MineSweeper.data.board[i][j];
                            cell.setAttribute("data-number", MineSweeper.data.board[i][j]);
                        }

                        if (
                            MineSweeper.data.isPeeking &&
                            !MineSweeper.data.savedState.revealed[i][j]
                        ) {
                            cell.classList.add("peeking");
                        }
                    } else if (MineSweeper.data.flagged[i][j]) {
                        cell.classList.add("flagged");
                        cell.textContent = "ğŸš©";
                    }

                    row.appendChild(cell);
                }
                board.appendChild(row);
            }

            // å¦‚æœè¿˜æ²¡æœ‰æ·»åŠ è¿‡äº‹ä»¶ç›‘å¬ï¼Œåˆ™æ·»åŠ 
            if (!board.hasAttribute("data-events-attached")) {
                // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
                board.addEventListener("mousedown", handleMouseDown);
                // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
                board.addEventListener("mouseover", handleMouseOver);
                // é¼ æ ‡ç¦»å¼€äº‹ä»¶
                board.addEventListener("mouseout", handleMouseOut);
                // é¼ æ ‡å³é”®äº‹ä»¶
                board.addEventListener("contextmenu", handleContextMenu);
                // ç‚¹å‡»äº‹ä»¶
                board.addEventListener("click", handleClick);

                // æ ‡è®°å·²æ·»åŠ äº‹ä»¶ç›‘å¬
                board.setAttribute("data-events-attached", "true");
            }
        }

        // äº‹ä»¶å¤„ç†å‡½æ•°
        function handleMouseDown(e) {
            if (MineSweeper.data.isPeeking || e.button !== 0) return;

            const cell = e.target.closest(".cell");
            if (!cell) return;

            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            if (!MineSweeper.data.revealed[row][col]) {
                cell.classList.add("pressing");
            } else if (MineSweeper.data.board[row][col] > 0) {
                pressNeighbors(row, col);
            }
        }

        function handleMouseOver(e) {
            if (MineSweeper.data.isPeeking || !e.buttons) return;

            const cell = e.target.closest(".cell");
            if (!cell) return;

            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            if (!MineSweeper.data.revealed[row][col]) {
                cell.classList.add("pressing");
            } else if (MineSweeper.data.board[row][col] > 0) {
                pressNeighbors(row, col);
            }
        }

        function handleMouseOut(e) {
            const cell = e.target.closest(".cell");
            if (!cell) return;

            cell.classList.remove("pressing");
            clearAllPressing();
        }

        function handleContextMenu(e) {
            e.preventDefault();
            if (MineSweeper.data.isPeeking) return;

            const cell = e.target.closest(".cell");
            if (!cell) return;

            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            MineSweeper.flag(row, col);
            renderBoard();
        }

        function handleClick(e) {
            if (MineSweeper.data.isPeeking) return;

            const cell = e.target.closest(".cell");
            if (!cell) return;

            // ç¡®ä¿éŸ³é¢‘å·²åˆå§‹åŒ–
            initSounds();

            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            MineSweeper.reveal(row, col);
            // æ›´æ–°æ£‹ç›˜æ˜¾ç¤º
            renderBoard();
        }

        // æ·»åŠ å…¨å±€é¼ æ ‡æŠ¬èµ·äº‹ä»¶
        document.addEventListener("mouseup", () => {
            clearAllPressing();
        });

        // æ·»åŠ æŒ‰ä¸‹å‘¨å›´æ ¼å­çš„å‡½æ•°
        function pressNeighbors(row, col) {
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    const newRow = row + i;
                    const newCol = col + j;

                    if (
                        newRow >= 0 &&
                        newRow < MineSweeper.config.rows &&
                        newCol >= 0 &&
                        newCol < MineSweeper.config.cols
                    ) {
                        const cells = document.querySelectorAll(".cell");
                        const index = newRow * MineSweeper.config.cols + newCol;
                        const neighborCell = cells[index];

                        if (
                            !MineSweeper.data.revealed[newRow][newCol] &&
                            !MineSweeper.data.flagged[newRow][newCol]
                        ) {
                            neighborCell.classList.add("pressing-neighbor");
                        }
                    }
                }
            }
        }

        // ä¿®æ”¹æ ·å¼ç›¸å…³çš„ä»£ç 
        function updateStyles() {
            const oldStyle = document.getElementById("dynamic-cell-styles");
            if (oldStyle) {
                oldStyle.remove();
            }

            const styleSheet = document.createElement("style");
            styleSheet.id = "dynamic-cell-styles";

            // æ·»åŠ å“åº”å¼æ ·å¼
            styleSheet.textContent = `
                .cell {
                    width: ${MineSweeper.config.cellSize}px;
                    height: ${MineSweeper.config.cellSize}px;
                    font-size: ${Math.max(
                MineSweeper.config.cellSize * 0.5,
                12
            )}px;
                }
                
                @media (max-width: 768px) {
                    .game-container {
                        padding: 10px;
                    }
                    
                    .difficulty-selector {
                        flex-wrap: wrap;
                        gap: 5px;
                    }
                    
                    .difficulty-btn {
                        padding: 4px 8px;
                        font-size: 12px;
                    }
                    
                    .controls {
                        padding: 5px;
                    }
                    
                    .mine-counter {
                        padding: 3px 8px;
                        font-size: 16px;
                    }
                    
                    .reset-button, .peek-button {
                        padding: 5px 12px;
                        font-size: 14px;
                    }
                }
            `;
            document.head.appendChild(styleSheet);
        }

        function resetGame() {
            const currentDifficulty = document.querySelector(
                ".difficulty-btn.active"
            ).dataset.difficulty;
            if (currentDifficulty !== "custom") {
                const config = MineSweeper.config.difficulties[currentDifficulty];
                MineSweeper.config.mines = config.mines;
                MineSweeper.config.rows = config.rows || config.size;
                MineSweeper.config.cols = config.cols || config.size;
            }

            MineSweeper.data.isPeeking = false;
            MineSweeper.data.savedState = null;
            document.querySelector(".peek-button").classList.remove("active");
            document.querySelector(".peek-button").textContent = "æŸ¥çœ‹åœ°é›·";
            MineSweeper.init();
            updateStyles();
            renderBoard();
            // é‡ç½®æ—¶æ›´æ–°å‰©ä½™åœ°é›·æ•°æ˜¾ç¤º
            document.getElementById("remaining-mines").textContent = MineSweeper.config.mines;
        }

        // ä¿®æ”¹çª—å£å¤§å°æ”¹å˜äº‹ä»¶ç›‘å¬
        window.addEventListener("resize", () => {
            // ä¿å­˜å½“å‰æ¸¸æˆçŠ¶æ€
            const currentState = {
                board: JSON.parse(JSON.stringify(MineSweeper.data.board)),
                revealed: JSON.parse(JSON.stringify(MineSweeper.data.revealed)),
                flagged: JSON.parse(JSON.stringify(MineSweeper.data.flagged)),
                mineCount: MineSweeper.data.mineCount,
                gameOver: MineSweeper.data.gameOver,
                isFirstClick: MineSweeper.data.isFirstClick
            };

            // è·å–å½“å‰è§†å£å°ºå¯¸
            const oldWidth = window.innerWidth;
            const oldHeight = window.innerHeight;

            // ä½¿ç”¨ setTimeout å»¶è¿Ÿæ£€æŸ¥ï¼Œé¿å…ç§»åŠ¨ç«¯æ»šåŠ¨è§¦å‘
            setTimeout(() => {
                // å¦‚æœè§†å£å°ºå¯¸çœŸçš„æ”¹å˜äº†ï¼ˆä¸æ˜¯å› ä¸ºæ»šåŠ¨å¯¼è‡´çš„ï¼‰
                if (oldWidth !== window.innerWidth || oldHeight !== window.innerHeight) {
                    // é‡æ–°è®¡ç®—æ ¼å­å¤§å°
                    MineSweeper.calculateCellSize();
                    updateStyles();
                    
                    // æ¢å¤æ¸¸æˆçŠ¶æ€
                    MineSweeper.data.board = currentState.board;
                    MineSweeper.data.revealed = currentState.revealed;
                    MineSweeper.data.flagged = currentState.flagged;
                    MineSweeper.data.mineCount = currentState.mineCount;
                    MineSweeper.data.gameOver = currentState.gameOver;
                    MineSweeper.data.isFirstClick = currentState.isFirstClick;
                    
                    renderBoard();
                }
            }, 300); // 300ms å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹è§¦å‘
        });

        // åœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨
        MineSweeper.initDifficultySelector();

        // åˆå§‹åŒ–æ¸¸æˆ
        resetGame();

        // æ·»åŠ é¢„è§ˆåˆ‡æ¢å‡½æ•°
        function togglePeek() {
            const peekButton = document.querySelector(".peek-button");

            if (!MineSweeper.data.isPeeking) {
                // ä¿å­˜å½“å‰çŠ¶æ€
                MineSweeper.data.savedState = {
                    revealed: JSON.parse(JSON.stringify(MineSweeper.data.revealed)),
                    flagged: JSON.parse(JSON.stringify(MineSweeper.data.flagged)),
                };

                // æ˜¾ç¤ºæ‰€æœ‰æ ¼å­
                for (let i = 0; i < MineSweeper.config.rows; i++) {
                    for (let j = 0; j < MineSweeper.config.cols; j++) {
                        MineSweeper.data.revealed[i][j] = true;
                    }
                }

                MineSweeper.data.isPeeking = true;
                peekButton.classList.add("active");
                peekButton.textContent = "æ¢å¤æ¸¸æˆ";
            } else {
                // æ¢å¤ä¿å­˜çš„çŠ¶æ€
                MineSweeper.data.revealed = JSON.parse(
                    JSON.stringify(MineSweeper.data.savedState.revealed)
                );
                MineSweeper.data.flagged = JSON.parse(
                    JSON.stringify(MineSweeper.data.savedState.flagged)
                );

                MineSweeper.data.isPeeking = false;
                peekButton.classList.remove("active");
                peekButton.textContent = "æŸ¥çœ‹åœ°é›·";
            }

            renderBoard();
        }

        // æ·»åŠ æ¸…é™¤æ‰€æœ‰æŒ‰å‹æ•ˆæœçš„è¾…åŠ©å‡½æ•°
        function clearAllPressing() {
            document
                .querySelectorAll(".pressing, .pressing-neighbor")
                .forEach((cell) => {
                    cell.classList.remove("pressing");
                    cell.classList.remove("pressing-neighbor");
                });
        }

        // æ·»åŠ ç§»åŠ¨ç«¯è®¾ç½®ç›¸å…³ä»£ç 
        function initMobileSettings() {
            const settingsBtn = document.querySelector(".mobile-settings-btn");
            const settingsModal = document.querySelector(".settings-modal");
            const closeBtn = document.querySelector(".close-settings");
            const settingsContent = document.querySelector(
                ".settings-content .difficulty-selector"
            );
            const originalSelector = document.querySelector(
                ".game-container .difficulty-selector"
            );

            // å°†åŸæœ‰çš„éš¾åº¦é€‰æ‹©å™¨å†…å®¹å¤åˆ¶åˆ°å¼¹å‡ºæ¡†ä¸­
            settingsContent.innerHTML = originalSelector.innerHTML;

            // é‡æ–°åˆå§‹åŒ–éš¾åº¦é€‰æ‹©å™¨çš„äº‹ä»¶ç›‘å¬
            MineSweeper.initDifficultySelector();

            // æ‰“å¼€è®¾ç½®
            settingsBtn.addEventListener("click", () => {
                settingsModal.style.display = "block";
            });

            // å…³é—­è®¾ç½®
            closeBtn.addEventListener("click", () => {
                settingsModal.style.display = "none";
            });

            // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­
            settingsModal.addEventListener("click", (e) => {
                if (e.target === settingsModal) {
                    settingsModal.style.display = "none";
                }
            });
        }

        // åœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨
        initMobileSettings();

        function initDraggableButton() {
            const btn = document.querySelector(".mobile-settings-btn");
            let isDragging = false;
            let startX, startY, initialX, initialY;
            let longPressTimer;
            const LONG_PRESS_DURATION = 500; // é•¿æŒ‰è§¦å‘æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

            // ä¿å­˜æŒ‰é’®ä½ç½®åˆ° localStorage
            function saveButtonPosition(x, y) {
                localStorage.setItem("settingsBtnPosition", JSON.stringify({ x, y }));
            }

            // ä» localStorage åŠ è½½æŒ‰é’®ä½ç½®
            function loadButtonPosition() {
                const pos = localStorage.getItem("settingsBtnPosition");
                if (pos) {
                    const { x, y } = JSON.parse(pos);
                    btn.style.left = x + "px";
                    btn.style.right = "auto";
                    btn.style.top = y + "px";
                    btn.style.transform = "none";
                }
            }

            // åˆå§‹åŒ–æ—¶åŠ è½½ä¿å­˜çš„ä½ç½®
            loadButtonPosition();

            // å¸é™„åˆ°è¾¹ç¼˜
            function snapToEdge(x, y) {
                const rect = btn.getBoundingClientRect();
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;

                // è®¡ç®—æŒ‰é’®ä¸­å¿ƒç‚¹
                const centerX = x + rect.width / 2;

                // å¸é™„åˆ°å·¦è¾¹æˆ–å³è¾¹
                if (centerX < windowWidth / 2) {
                    x = 10; // å·¦è¾¹è·
                } else {
                    x = windowWidth - rect.width - 10; // å³è¾¹è·
                }

                // ç¡®ä¿ä¸è¶…å‡ºä¸Šä¸‹è¾¹ç•Œ
                y = Math.max(10, Math.min(windowHeight - rect.height - 10, y));

                return { x, y };
            }

            // è§¦æ‘¸äº‹ä»¶å¤„ç†
            btn.addEventListener("touchstart", (e) => {
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                initialX = btn.offsetLeft;
                initialY = btn.offsetTop;

                // è®¾ç½®é•¿æŒ‰å®šæ—¶å™¨
                longPressTimer = setTimeout(() => {
                    isDragging = true;
                    btn.classList.add("dragging");
                }, LONG_PRESS_DURATION);
            });

            btn.addEventListener("touchmove", (e) => {
                if (!isDragging) {
                    // å¦‚æœç§»åŠ¨è·ç¦»è¿‡å¤§ï¼Œå–æ¶ˆé•¿æŒ‰
                    const touch = e.touches[0];
                    const moveX = Math.abs(touch.clientX - startX);
                    const moveY = Math.abs(touch.clientY - startY);
                    if (moveX > 5 || moveY > 5) {
                        clearTimeout(longPressTimer);
                    }
                    return;
                }

                e.preventDefault();
                const touch = e.touches[0];
                let newX = initialX + (touch.clientX - startX);
                let newY = initialY + (touch.clientY - startY);

                btn.style.right = "auto";
                btn.style.left = newX + "px";
                btn.style.top = newY + "px";
                btn.style.transform = "none";
            });

            function endDragging() {
                if (isDragging) {
                    isDragging = false;
                    btn.classList.remove("dragging");

                    // è·å–å½“å‰ä½ç½®å¹¶å¸é™„åˆ°è¾¹ç¼˜
                    const rect = btn.getBoundingClientRect();
                    const { x, y } = snapToEdge(rect.left, rect.top);

                    // åº”ç”¨å¸é™„åçš„ä½ç½®
                    btn.style.left = x + "px";
                    btn.style.top = y + "px";

                    // ä¿å­˜ä½ç½®
                    saveButtonPosition(x, y);
                }
                clearTimeout(longPressTimer);
            }

            btn.addEventListener("touchend", endDragging);
            btn.addEventListener("touchcancel", endDragging);

            // ç‚¹å‡»äº‹ä»¶ï¼ˆéæ‹–åŠ¨æ—¶ï¼‰
            btn.addEventListener("click", (e) => {
                if (!isDragging) {
                    // æ‰“å¼€è®¾ç½®é¢æ¿
                    document.querySelector(".settings-modal").style.display = "block";
                }
            });
        }

        // åœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨
        initDraggableButton();

        let totalMines = 0;  // æ·»åŠ ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨æ€»åœ°é›·æ•°
        let markedMines = 0; // æ·»åŠ ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨å·²æ ‡è®°çš„åœ°é›·æ•°

        function initGame() {
            // ... existing code ...
            totalMines = mineCount;
            markedMines = 0;
            updateMineCounter();
            // ... existing code ...
        }

        function updateMineCounter() {
            document.getElementById('remaining-mines').textContent = totalMines - markedMines;
        }

        function handleRightClick(event) {
            event.preventDefault();
            if (!gameStarted) return;
            
            const cell = event.target;
            if (cell.classList.contains('revealed')) return;
            
            if (cell.classList.contains('marked')) {
                cell.classList.remove('marked');
                markedMines--;
            } else {
                cell.classList.add('marked');
                markedMines++;
            }
            
            updateMineCounter();
        }

        // æ›¿æ¢åŸæœ‰çš„éŸ³é¢‘åˆå§‹åŒ–å’Œæ’­æ”¾ä»£ç 
        const AudioManager = {
            context: null,
            buffers: {},
            sounds: {},
            
            init() {
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                this.context = new (window.AudioContext || window.webkitAudioContext)();
                
                // é¢„åŠ è½½æ‰€æœ‰éŸ³æ•ˆ
                Object.keys(MineSweeper.config.soundUrls).forEach(key => {
                    fetch(MineSweeper.config.soundUrls[key])
                        .then(response => response.arrayBuffer())
                        .then(arrayBuffer => this.context.decodeAudioData(arrayBuffer))
                        .then(audioBuffer => {
                            this.buffers[key] = audioBuffer;
                        })
                        .catch(error => console.log('éŸ³é¢‘åŠ è½½å¤±è´¥:', error));
                });
            },
            
            play(soundName) {
                if (this.buffers[soundName]) {
                    // åˆ›å»ºéŸ³æº
                    const source = this.context.createBufferSource();
                    source.buffer = this.buffers[soundName];
                    
                    // åˆ›å»ºéŸ³é‡æ§åˆ¶
                    const gainNode = this.context.createGain();
                    gainNode.gain.value = 0.3; // è®¾ç½®éŸ³é‡

                    // å¦‚æœæ˜¯ flag éŸ³æ•ˆï¼ˆç©ºç™½åŒºåŸŸå±•å¼€éŸ³æ•ˆï¼‰ï¼Œç¼©çŸ­å…¶æŒç»­æ—¶é—´
                    if (soundName === 'flag') {
                        // è®¾ç½®éŸ³é¢‘æ’­æ”¾æ—¶é•¿ä¸ºåŸå§‹é•¿åº¦çš„ 30%
                        source.playbackRate.value = 3.0;
                        gainNode.gain.value = 0.2; // é™ä½éŸ³é‡
                    }
                    
                    // è¿æ¥èŠ‚ç‚¹
                    source.connect(gainNode);
                    gainNode.connect(this.context.destination);
                    
                    // ç«‹å³æ’­æ”¾
                    source.start(0);
                }
            }
        };

        // ä¿®æ”¹éŸ³é¢‘åˆå§‹åŒ–å‡½æ•°
        function initSounds() {
            if (!AudioManager.context) {
                AudioManager.init();
            }
        }

        // ä¿®æ”¹éŸ³é¢‘æ’­æ”¾å‡½æ•°
        function playSound(soundName) {
            if (!AudioManager.context) {
                initSounds();
            }
            AudioManager.play(soundName);
        }

        // åœ¨ç”¨æˆ·é¦–æ¬¡äº¤äº’æ—¶åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ
        document.addEventListener('click', function initAudioOnFirstClick() {
            initSounds();
            document.removeEventListener('click', initAudioOnFirstClick);
        }, { once: true });
    </script>
</body>

</html>